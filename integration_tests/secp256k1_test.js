const assert = require('assert');
const path = require('path');
const util = require('./utils');
const async = require('async');
const BigNumber = require("bignumber.js");
const testdata = require('./data/secp2561k_data.json');

var secp256k1;

const bytecode = "6060604052611284806100126000396000f3606060405260e060020a600035046304e960d7811461004757806323e47a01146101955780634f5dde4c146101e75780639f6fc3c014610222578063da8b0d711461029d575b005b60408051808201825261034991600480359290916064919060249060029083908390808284378051808201825292979660a49650929450919291849150839080828437509095505050505050600061039f84848460006000600060006060604051908101604052806003905b60008152602001906001900390816100b357505060408051606081019091526003815b60008152602001906001900390816100d657505060408051606081019091526003815b60008152602001906001900390816100f9575050885170014551231950b75fc4402da1732fc9bebe1996506401000003d019955060009081148061013f57508951879010155b8061014e575060208a01516000145b8061017d575060208a01517f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a090115b156103bd57600097505b505050505050509392505050565b60408051808201825261035b9160049160449183906002908390839080828437509095505050505050600060006103a7836000808281508051915060016020919091015181161461063c57600061063f565b604080518082018252610349916004916044918390600290839083908082843750909550505050505060006103b0825b60006103b082610252565b604080518082018252610349916004916044918390600290839083908082843750909550505050505060006103b0825b60006401000003d01981808481505181148061026e5750845183145b8061027d575060208501516000145b8061028b5750602085015183145b1561064657600093505b505050919050565b61037b6004356024356040604051908101604052806002905b60008152602001906001900390816102b6579050506103b683836040604051908101604052806002905b60008152602001906001900390816102e057506401000003d0199050600080808360078180898009890908925061066d837f3fffffffffffffffffffffffffffffffffffffffffffffffffffffffbfffff0c86600060008460001415610e04575b509392505050565b60408051918252519081900360200190f35b604051808360ff1681526020018281526020019250505060405180910390f35b60408051908190839080838184600060046021f15090500191505060405180910390f35b949350505050565b91509150915091565b92915050565b9392505050565b6103c689610217565b15156103d55760009750610187565b60208a015161040f90885b60006000600060006000600087600014806103fa57508688145b806104055750866000145b156106ad57610002565b945061054f87868d09604080518082019091527f79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179881527f483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b860208201525b6060604051908101604052806003905b600081526020019060019003908161047c57905050600060006000610300604051908101604052806008905b6060604051908101604052806003905b60008152602001906001900390816104b8579050508152602001906001900390816104a857505060408051606081019091526003815b60008152602001906001900390816104ee5750506040805161020081019091526010815b6000815260200190600190039081610512579050506000600060006401000003d01998508b600014156106fd575b50505050505050505092915050565b935061056487868c600050508c51098a61046c565b92506105fb84845b6060604051908101604052806003905b600081526020019060019003908161057c5790505060006080604051908101604052806004905b60008152602001906001900390816105a357505060408051608081019091526004815b60008152602001906001900390816105c6575060009050808080808a60029090602002015160001415610cec57899850610cde565b6040810151909250600014156106145760009750610187565b604082015161062390876103e0565b905085868283098351098a518882061498509050610187565b60015b9150915091565b60208501518390800985519092508390600790829081818009090890508082149350610295565b8686529150506001811660ff8716186000811461068c5781840361068e565b815b6020860152509295945050505050565b8495505b505050505092915050565b868811156106bb5796869006965b600193508692508791505b600082146106e75750919282820480850290910392918183029003906106c6565b600085121561069e5784600003870395506106a2565b6000604051985061020089016040525b8c156107455760018d1615610734575060208c06808989015360206010821102818e03019c505b60028d049c5060018801975061070d565b50604080516060810182528c51815260208d810151908201526001918101919091528087526107739061082e565b9450610875858c6060604051908101604052806003905b600081526020019060019003908161078a5790505060006040604051908101604052806002905b60008152602001906001900390816107b157505060408051608081019091526004815b60008152602001906001900390816107d4575060009050808080808a60029090602002015160001415610ef457604080516060810182528b51815260208c810151908201526001918101919091529850610cde565b610dfd8b5b6060604051908101604052806003905b600081526020019060019003908161083e57506401000003d0199050600080808080808860025060400151811415610e8357610ee8565b6020870181905261088790869061056c565b6040870181905261089990869061056c565b606087018190526108ab90869061056c565b608087018190526108bd90869061056c565b60a087018190526108cf90869061056c565b60c087018190526108e190869061056c565b60e087015260208601516040015180855289908760025050604088810151015109602085018190526060870151604001518a9190096040858101829052608088015101518a9190096060850181905260a0870151604001518a9190096080850181905260c0870151604001518a91900960a0850181905260e0870151604001518a91900960c08501819052610976908a6103e0565b60e08501819052610100850181905260a08501518a9190096101e0850152600692505b60028310610a0057610100840151899087600186016008811015610002576020020151604001510961010085018190528990856001198601601081101561000257602002015109848460080160108110156100025760200201526000199290920191610999565b6040868101516101008601519101518a919009610120850152600092505b6007831015610c1957610aa486846001016008811015610002576020020151856009860160108110156100025760200201518b87600988016010811015610002576020020151886009890160108110156100025760200201510982518d908190839009845280808385096020860151096020850152505060016040929092019190915250565b60019290920191610a1e565b6010821115610bb557600282601f030490508050610c198a60406040519081016040528089856008811015610002575050602085028a015160009090602002015181526020018985600881101561000257505060208581028b015101518d0390525b60006040604051908101604052806002905b6000815260200190600190039081610b2457505060408051608081019091526004815b6000815260200190600190039081610b475750600090508080808089600190906020020151600014156111a05788518a52602089810151908b0152600160408b0152611194565b61127f8a5b6401000003d01960008080808080876002506040015181141561108c576110f1565b6000821115610c19576002600183030490508050610c198a60406040519081016040528089856008811015610002575050602085028a015160009090602002015181526020018985600881101561000257505060208581028b015101519052610b12565b6000871115610540578688016000199081015197019660001a9150610ab08a610b93565b8551604087015189918203900860208701516060880151919650899190820390089350878586099250878584099150878289038986870908905087808085896000505089510960020989038208808a5286519091508890819083820390829087900908850960208a8101919091528601518890819084900981038a6001909060200201510860208a015260408a810151908c01518991829109860960408a01525b505050505050505092915050565b60408a015160001415610d01578a9850610cde565b60408b01516401000003d01998508890800980885260408c015189919009602088015260408a01518890800960408881018290528b015189919009606088015260408051608081018252908801518c5182918b9109815260200189896003600481101561000257505060608a015160208f015109815260200189896000600481101561000257505089518d5109815260200189896001600481101561000257505060208a810151908e0151099052955085600290906020020151866000600481101561000257909060200201511415610c3d57856003909060200201518660016004811015610002579090602002015114151561082957610cde565b9850610cde565b8360001415610e165760019150610341565b8260001415610e2457610002565b506001905060ff60020a5b801561034157828185161515860a84848509099150826002820485161515860a84848509099150826004820485161515860a84848509099150826008820485161515860a8484850909915060109004610e2f565b885160208a015190965094508685800993508687858809600409925086878788096003099150868784850888038884850908808952905086808086800960080988038889848b0387088509086020890152604089015187908190870960020960408901525b50505050505050919050565b60208a015160001415610f09578a9850610cde565b60408b01516401000003d01998508890800980885260408c015189919009602088810191909152604080516080810182528d5181528d83015192810192909252810189896000505089518d5109815260200189896001600281101561000257505060208a810151908e0151099052955085600290906020020151866000600481101561000257909060200201511415610fdf578560039090602002015186600160048110156100025790906020020151141515610fd6576000808c5260208c0181905260408c0152610cde565b6110868b61082e565b8551604087015189918203900860208701516060880151919650899190820390089350878586099250878584099150878289038986870908905087808085896000505089510960020989038208808a5286519091508890819083820390829087900908850960208a8101919091528601518890819084900981038a6001909060200201510860208a015260408b01518890860960408a015250969998505050505050505050565b50610cde565b8751602089015190965094508685800993508687858809600409925086878788096003099150868784850888038884850908808952905086808086800960080988038889848b0387088509086020890152604088015187908190870960020960408901525b5050505050505050565b8551604087015189918203900860208701516060880151919650899190820390089350878586099250878584099150878289038986870908905087808085896000505089510960020989038208808b5286519091508890819083820390829087900908850960208b8101919091528601518890819084900981038b6001909060200201510860208b015260408a01518890860960408b01525b50505050505050505050565b6020890151600014156111b257611194565b60408a01516401000003d01998508890800980885260408b015189919009602088810191909152604080516080810182528c5181528c83015192810192909252810189896000505089518c5109815260200189896001600281101561000257505060208a810151908d01510990529550856002909060200201518660006004811015610002579090602002015114156110fb578560039090602002015186600160048110156100025790906020020151141515610b8e576000808b5260208b0181905260408b0152611194565b61119456";
const ABI = [{
    "constant": true,
    "inputs": [{"name": "h", "type": "bytes32"}, {"name": "rs", "type": "uint256[2]"}, {
        "name": "Q",
        "type": "uint256[2]"
    }],
    "name": "validateSignature",
    "outputs": [{"name": "", "type": "bool"}],
    "type": "function"
}, {
    "constant": true,
    "inputs": [{"name": "P", "type": "uint256[2]"}],
    "name": "compress",
    "outputs": [{"name": "yBit", "type": "uint8"}, {"name": "x", "type": "uint256"}],
    "type": "function"
}, {
    "constant": true,
    "inputs": [{"name": "P", "type": "uint256[2]"}],
    "name": "isPubKey",
    "outputs": [{"name": "", "type": "bool"}],
    "type": "function"
}, {
    "constant": true,
    "inputs": [{"name": "P", "type": "uint256[2]"}],
    "name": "onCurve",
    "outputs": [{"name": "", "type": "bool"}],
    "type": "function"
}, {
    "constant": true,
    "inputs": [{"name": "yBit", "type": "uint8"}, {"name": "Px", "type": "uint256"}],
    "name": "decompress",
    "outputs": [{"name": "", "type": "uint256[2]"}],
    "type": "function"
}];

describe('Crypto', function () {

    before(function (done) {
        this.timeout(300000); // 5 minutes.
        util.initWeb3(function (err) {
            if (err)
                return done(err);
            util.deploy(ABI, bytecode, function (err, contract) {
                if (err)
                    return done(err);
                secp256k1 = contract;
                done();
            });
        });
    });

    describe('Secp256k1Curve', function () {

        describe('#onCurve()', function () {

            it('should detect that the given points are on the curve', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.randomPoints, function (point, idx, cb) {
                        secp256k1.onCurve(point, function (err, result) {
                            assert.ifError(err);
                            assert(result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should detect that the given points are not on the curve', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.randomPoints, function (point, idx, cb) {
                        secp256k1.onCurve([point[0] + 1, point[1]], function (err, result) {
                            assert.ifError(err);
                            assert(!result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });
        });

        describe('#isPubKey()', function () {

            it('should detect that the given points are valid public keys', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.randomPoints, function (point, idx, cb) {
                        secp256k1.isPubKey(point, function (err, result) {
                            assert.ifError(err);
                            assert(result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should detect that the given points are not valid public keys', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.randomPoints, function (point, idx, cb) {
                        secp256k1.isPubKey([point[0] + 1, point[1]], function (err, result) {
                            assert.ifError(err);
                            assert(!result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });
        });

        describe('#validateSignature()', function () {

            it('should detect that the given signatures are valid', function (done) {
                this.timeout(10000);
                var message = testdata.message;
                async.forEachOfSeries(testdata.keypairs, function (keypair, idx, cb) {
                        var signature = testdata.signatures[idx];
                        secp256k1.validateSignature(message, signature, keypair.pub, function (err, result) {
                            assert.ifError(err);
                            assert(result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should detect that the public key does not correspond to the given signature', function (done) {
                this.timeout(10000);
                var message = testdata.message;
                async.forEachOfSeries(testdata.keypairs, function (keypair, idx, cb) {
                        var signature = testdata.signatures[17 - idx];
                        secp256k1.validateSignature(message, signature, keypair.pub, function (err, result) {
                            assert.ifError(err);
                            assert(!result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should detect that the given signatures and pubkeys are wrong for the given message', function (done) {
                this.timeout(10000);
                var message = "0x1234123412341234123412341234123412341234123412341234123412341234";
                async.forEachOfSeries(testdata.keypairs, function (keypair, idx, cb) {
                        var signature = testdata.signatures[idx];
                        secp256k1.validateSignature(message, signature, keypair.pub, function (err, result) {
                            assert.ifError(err);
                            assert(!result);
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should compress a set of points successfully', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.keypairs, function (keypair, idx, cb) {
                        secp256k1.compress(keypair.pub, function (err, result) {
                            assert.ifError(err);
                            var x = new BigNumber(keypair.pub[0]);
                            var yBit = new BigNumber(keypair.pub[1]).mod(2);
                            assert(yBit.eq(result[0]));
                            assert(x.eq(result[1]));
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

            it('should decompress a set of points successfully', function (done) {
                this.timeout(10000);
                async.forEachOfSeries(testdata.keypairs, function (keypair, idx, cb) {
                        var x = new BigNumber(keypair.pub[0]);
                        var yBit = new BigNumber(keypair.pub[1]).mod(2);
                        secp256k1.decompress(yBit, x, function (err, result) {
                            assert.ifError(err);
                            assert(new BigNumber(keypair.pub[0]).eq(result[0]));
                            assert(new BigNumber(keypair.pub[1]).eq(result[1]));
                            cb();
                        })
                    }, function () {
                        done();
                    }
                );
            });

        });

    });

});